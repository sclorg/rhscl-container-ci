# Requires:
# {name}
# {gituser}
# {gitproject}
# {targetOS}
# {trigger_phrase}
# {project_trigger}
# {hub_namespace}
- job-template:
    name: 'rhscl-images-{name}-build'
    node: slave_rhel7_root
    wrappers:
      - timestamps
      - credentials-binding:
          - text:
              variable: "GITHUB_TOKEN"
              credential-id: 'f12f925d-cbc0-47fd-ab22-47f8d63ed6c0'
    scm:
        - images-build:
            gituser: '{gituser}'
            gitproject: '{gitproject}'
    triggers:
        - scm_fifteen_minutes
        - reverse:
            jobs: '{project_trigger}'
    builders:
        - add_dependencies_remote:
            name: '{name}'
        - prepare-rhscl-images
        - shell: |
            #!/bin/bash
            set -ex

            # Copy sources and prepare shared sources (build scripts)
            rsync -avzP -e 'ssh -F ssh_config' $(pwd)/ host:sources
            ssh -F ssh_config host 'cd sources && git submodule update --init'

        - image-test:
            targetOS: 'centos7'
        - image-build-push:
            targetOS: 'centos7'
            hub_namespace: '{hub_namespace}'
        - docker-hub-update:
            targetOS: 'centos7'
            hub_namespace: '{hub_namespace}'
    publishers:
        - release-vm
        - github-notifier
        - email:
            recipients: 'mskalick@redhat.com hhorak@redhat.com'
