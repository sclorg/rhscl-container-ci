# Requires:
# {targetOS}
# {hub_namespace}
- builder:
    name: 'image-build-push'
    builders:
        - shell: |
            #!/bin/bash
            set -ex

            # Push generated branch
            ssh -F ssh_config host 'set -ex; cd sources; \
              if git branch | grep -q generated; then \
                GIT_URL=$(git remote -v | head -n 1 | tr '\t' ' ' | cut -f 2 -d' '); \
                git remote add auth_origin ${{GIT_URL/#git:\/\//https:\/\/$GITHUB_TOKEN@}}; \
                git push auth_origin generated; \
              fi'

            # Push images
            ssh -F ssh_config host 'set -ex; \
              cd sources; make tag TARGET={targetOS} | tee output;'

            ssh -F ssh_config host bash << 'EOF'
            set -ex; cd sources;
            for image in $(cat output | grep -- '-> Tagging image' | cut -d' ' -f 6,8 | sed "s/'//g"); do
              echo "Pushing ${{image}}"
              docker tag ${{image}} docker.io/${{image}}
              HOME=~/.docker_credentials/{hub_namespace} docker push docker.io/${{image}}
            done
            rm output
            EOF

